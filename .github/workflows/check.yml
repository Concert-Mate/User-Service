name: Container Health Check

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  container-health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run health checks
        run: docker-compose up -d

      - name: Run health checks
        run: |
          export $(grep -E -v '^#' .env | xargs)
          echo "Environment variables sourced from .env file."

          docker-compose up -d

          docker-compose exec -T postgres pg_isready -h localhost -U $POSTGRES_USER -d $POSTGRES_DB

          docker-compose exec -T postgres psql -h localhost -U $POSTGRES_USER -d $PROJECT_USER_DATABASE_NAME -c "SELECT * FROM pg_roles WHERE rolname='$PROJECT_USER_NAME';" | grep -q $PROJECT_USER_NAME || exit 1
          docker-compose exec -T postgres psql -h localhost -U $POSTGRES_USER -d $PROJECT_USER_DATABASE_NAME -c "SELECT * FROM pg_roles WHERE rolname='$PROJECT_USER_NAME' AND rolpassword='$PROJECT_USER_PASSWORD';" | grep -q $PROJECT_USER_NAME || exit 1

          echo "ELASTIC_USER=$ELASTIC_USER"
          echo "ELASTIC_PASSWORD=$ELASTIC_PASSWORD"
          
          docker-compose exec -T elasticsearch curl -f -X GET 'localhost:9200/_cat/health?v' --user $ELASTIC_USER:$ELASTIC_PASSWORD | grep -q 'green' || true

      - name: Run health checks
        run: docker-compose down -v

